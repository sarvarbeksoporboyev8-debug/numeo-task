// IMPROVEMENT: wrap transcribeAudio with proper error handling
// Previously raw axios errors would propagate with unhelpful messages
async function transcribeAudio(audioData: string): Promise<string> {
  try {
    console.log('Transcribing audio with Whisper API...');
    
    if (!process.env.WHISPER_API_KEY) {
      throw new Error('WHISPER_API_KEY not set');
    }

    const base64Data = audioData.replace(/^data:audio\/wav;base64,/, '');
    const audioBuffer = Buffer.from(base64Data, 'base64');

    const form = new FormData();
    form.append('file', audioBuffer, { filename: 'audio.wav', contentType: 'audio/wav' });
    form.append('model', 'whisper-1');

    console.log('Calling Whisper API...');
    const response = await axios.post(
      `${process.env.WHISPER_BASE_URL}/audio/transcriptions`,
      form,
      {
        headers: {
          'Authorization': `Bearer ${process.env.WHISPER_API_KEY}`,
          ...form.getHeaders()
        },
        timeout: 60000
      }
    );

    const transcribedText = response.data.text;
    console.log('Transcribed:', transcribedText);
    return transcribedText;
  } catch (error: any) {
    console.error('Whisper API error:', {
      status: error.response?.status,
      message: error.response?.data?.error?.message || error.message
    });
    throw new Error(error.response?.data?.error?.message || 'Failed to transcribe audio');
  }
}

// IMPROVEMENT: wrap translateText with proper error handling
async function translateText(text: string, targetLanguage: string): Promise<string> {
  try {
    console.log(`Translating to ${targetLanguage}...`);
    
    if (!process.env.DEEPSEEK_API_KEY) {
      throw new Error('DEEPSEEK_API_KEY not set');
    }

    const targetLangName = languageMap[targetLanguage] || targetLanguage;

    console.log('Calling DeepSeek API...');
    const response = await axios.post(
      `${process.env.DEEPSEEK_BASE_URL}/chat/completions`,
      {
        model: process.env.DEEPSEEK_MODEL || 'deepseek-chat',
        messages: [
          {
            role: 'system',
            content: 'You are a translator. Translate the following text to the target language. Only provide the translation, nothing else.'
          },
          {
            role: 'user',
            content: `Translate this text to ${targetLangName}:\n\n${text}`
          }
        ],
        temperature: 0.3,
        max_tokens: 1000
      },
      {
        headers: {
          'Authorization': `Bearer ${process.env.DEEPSEEK_API_KEY}`,
          'Content-Type': 'application/json'
        },
        timeout: 30000
      }
    );

    const translatedText = response.data.choices[0].message.content;
    console.log('Translated:', translatedText);
    return translatedText;
  } catch (error: any) {
    console.error('DeepSeek API error:', {
      status: error.response?.status,
      message: error.response?.data?.error?.message || error.message
    });
    throw new Error(error.response?.data?.error?.message || 'Failed to translate text');
  }
}
